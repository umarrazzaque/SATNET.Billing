@model SATNET.WebApp.Models.Hardware.CreateHardwareComponentRegistrationModel
@*@{
        var controller = HttpContext.Current.Request.RequestContext.RouteData.Values["controller"].ToString();
    }*@

<!-- Main content -->
@*@await Component.InvokeAsync("ContentHead", @Model.MenuModel)*@
<form method="post" data-ajax="true" asp-controller="LogisticBUC" asp-action="Add" data-ajax-method="post"
      enctype="multipart/form-data" id="formAdd" autocomplete="off">
    <div class="app-page-title">
        <div class="page-title-wrapper">
            <div class="page-title-heading">
                <div>
                    Add BUC
                    <div class="page-title-subheading">
                        Please fillout following form
                    </div>
                </div>
            </div>
            <div class="page-title-actions">
                <div class="d-inline-block dropdown">
                    <a href="@String.Format("/{0}", "LogisticBUC/Index")" class=" btn btn-danger">
                        Cancel
                    </a>
                    <button type="submit" id="btn_submit_serials" class="btn btn-default">Save BUC</button>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div asp-validation-summary="ModelOnly" class="text-danger"></div>
        @Html.HiddenFor(model => model.HardwareComponentRegistrationModel.SerialNumbers)

        <div class="col-lg-4">
            <div class="position-relative form-group">
                <label>Transceiver Model</label>
                @Html.DropDownListFor(model => model.HardwareComponentRegistrationModel.HardwareComponentId, new SelectList(Model.HardwareComponentList as System.Collections.IEnumerable, "Id", "HCValue"), "--SELECT TRIA MODEL--", new { @class = "form-control select2 text-input" })
            </div>
        </div>
        <div class="col-lg-4">
            <div class="position-relative form-group">
                @Html.LabelFor(model => model.HardwareComponentRegistrationModel.SerialNumber, new { })
                <div class="input-group mb-3">
                    @Html.EditorFor(model => model.HardwareComponentRegistrationModel.SerialNumber, new { htmlAttributes = new { @class = "form-control text-input", @placeholder = "Serial Number", @type = "number" } })

                    <div class="input-group-append">
                        <button class="btn-info add_hm_item" type="button">Save</button>
                    </div>
                    

                </div>
                </div>
            </div>
        <div class="col-lg-4">
            <span class="help-block text-danger" id="label_error"></span>
        </div>
        @*<div class="col-lg-4">
            <div class="position-relative form-group">
                @Html.LabelFor(model => model.HardwareComponentRegistrationModel.AIRMAC, new { id = "label_item" })
                <div class="input-group mb-3">
                    @Html.EditorFor(model => model.HardwareComponentRegistrationModel.AIRMAC, new { htmlAttributes = new { @class = "form-control text-input", @placeholder = "AIRMAC", @type = "text" } })

                    <div class="input-group-append">
                        <button class="btn-info add_hm_item" type="button">Save</button>
                    </div>

                </div>
            </div>
        </div>*@

    </div>
    <div class="row">
        <div class="col-lg-12">
            <h5 class="title">Transceiver List</h5>
        </div>
        <div class="col-lg-12">
            <div class="table-responsive dataTables_wrapper dt-bootstrap4 mt-2">
                <table id="grid_table" class="align-middle  table table-sm table-hover dataTable" role="grid" aria-describedby="">
                    <thead>
                        <tr>
                            <th class="text-center">#</th>
                            <th class="text-left">Transceiver Model</th>
                            <th class="text-left"> @Html.DisplayName("Serial Number") </th>
                            <th class="text-center"> Actions </th>
                        </tr>
                    </thead>
                    <tbody id="reg_table_body">
                    </tbody>
                </table>

            </div>
        </div>

    </div>
</form>


<!-- /.Main content -->

<script language="javascript" type="text/javascript">
    //$.validator.unobtrusive.parse('#formAdd');

    $('#HardwareComponentRegistrationModel_HardwareComponentId').change(function () {
        $('#reg_table_body').empty();
        $('#HardwareComponentRegistrationModel_SerialNumbers').val('');
        specsObj = '';
        grid_obj_array = [];
    });

    var grid_obj_array = [];
    var edit_flag = -1;
    var edit_record_index = -1;
    var specs_seperator = '---';
    var node_object_key = 'node_object';
    var section_type = 'AIR MAC NUMBER';
    $('#HardwareComponentRegistrationModel_HardwareTypeId').change(function () {
        var hardware_type = $('#HardwareComponentRegistrationModel_HardwareTypeId').val();
        $.ajax({
            url: '/HardwareComponentRegistration/GetHardwareComponetByHardwareType',
            type: "POST",
            data: { hardware_type_id: hardware_type },
            dataType: "json",
            error: function (response) {
            },
            success: function (response) {
                payment_filter_list = response;
                console.log(response);
                var options = "<option value'>--SELECT HARDWARE COMPONENT--</option>";
                //"<option value=''>--SELECT " + retModel.Column + "--</option>";
                $.each(response, function (i, plan) {
                    options += "<option value='" + plan.id + "'>" + plan.hcValue + "</option>";//selected='selected'
                });
                $('#HardwareComponentRegistrationModel_HardwareComponentId').empty().append(options);
                $('#HardwareComponentRegistrationModel_AIRMAC').attr('placeholder', section_type);
                $('#label_item').text(section_type);
            }
        });
        $('#table_header_section_type').text(section_type);
    });
    function record_exist_or_not(grid_array, obj) {
        var return_val = 0;
        var returnMessage = '';
        $.each(grid_array, function (i, item) {
            if (item.specsOne == obj.specsOne) {
                return_val = 1;
                returnMessage = 'Serial Number Already Exist';
                return;
            }
        });
        return [return_val, returnMessage];
    }
    function get_record_index(grid_array, obj) {
        var return_val = -1;
        $.each(grid_obj_array, function (i, item) {
            if (item.specsOne == obj.specsOne) {
                return_val = i;
                return;
            }
        });
        return return_val;
    }
    $('#btn_submit_serials').on('click', function (e) {
        //$('#label_error').text('Record Exist in DB!');
        var specsObj = '';
        $.each(grid_obj_array, function (i, item) {
            specsObj += item.specsOne + ',';
        });
        var ok = 'A';
        if (ok == 'A') {
            e.preventDefault();
        } else {

        }
        console.log(specsObj);
        console.log(typeof specsObj);
    });
    function checkRecordinDB(section, serialNumber, airMacNumber) {
        var result = false;
        $.ajax({
            url: '/LogisticsAIRMAC/CheckRecordinDB',
            type: "POST",
            data: { section: section, serialNumber: serialNumber, airMacNumber: airMacNumber},
            dataType: "json",
            error: function (response) {
            },
            success: function (response) {
                result = true;
                console.log(response.isSuccess);
            }
        });
    }
    $(document).on('click', '.add_hm_item', function () {
        var specsOne = $('#HardwareComponentRegistrationModel_SerialNumber').val();
        //console.log(serialNo + ':' + AIRMAC);
        var grid_obj_item = {
            specsOne: specsOne
        }
        console.log($('#HardwareComponentRegistrationModel_HardwareComponentId').val());
        if ($('#HardwareComponentRegistrationModel_HardwareComponentId').val() == "") {
            $('#label_error').text('Select Transceiver Model');
        }
        else if (specsOne == '') {
            console.log('Specs One');
            $('#label_error').text('Serial Number should not be empty');
        }
        else {
            //---Check Record Exist in Grid
            var returnVal = record_exist_or_not(grid_obj_array, grid_obj_item);
            if (returnVal[0] == 0) { // Not Exist
                //Check in DB
                //if (checkRecordinDB('BUC', specsOne, '') == true) {
                //    $('#label_error').text('Record Exist in DB!');
                //}
                //else {
                    //Not Exist in DB
                    if (edit_flag == 1) {
                        grid_obj_array[edit_record_index] = grid_obj_item;
                    }
                    else {
                        grid_obj_array.push(grid_obj_item);
                    }
                    load_table(grid_obj_array);
                    reset_config();
                //}
                
            }
            else { //Exist
                $('#label_error').text(returnVal[1]);
                if (edit_flag == 1) {
                    grid_obj_array[edit_record_index] = grid_obj_item;
                }
            }

        }

    });
    $(document).on('click', '.row_edit', function () {
        var grid_obj = $(this).attr('data-' + node_object_key);
        grid_obj = JSON.parse(grid_obj);
        $('#HardwareComponentRegistrationModel_SerialNumber').val(grid_obj.specsOne);
        edit_record_index = get_record_index(grid_obj_array, grid_obj);
        console.log('index:' + edit_record_index);
        edit_flag = 1;

        //var record_value = $(this).attr('data-val');
        //edit_record_index = mac_address_array.indexOf(record_value);
        //edit_flag = 1;
        //$('#HardwareComponentRegistrationModel_SerialNumber').val(record_value);
    });
    $(document).on('click', '.row_delete', function () {
        var record_value = $(this).attr('data-val');
        mac_address_array = mac_address_array.filter(e => e !== record_value); // will return ['A', 'C']
        load_table(mac_address_array);
        reset_config();
    });
    function reset_config() {
        $('#HardwareComponentRegistrationModel_SerialNumber').val('');
        $('#label_error').text('');
        edit_flag = edit_record_index = -1;
    }
    function load_table(record_array) {
        var rows = '';
        $.each(record_array, function (i, item) {
            rows += add_row(item, i + 1);
        });
        $("#reg_table_body > tbody").html("");
        $('#reg_table_body').html(rows);
        $('#HardwareComponentRegistrationModel_SerialNumbers').val('');
        var specsObj = '';
        $.each(record_array, function (i, item) {
             specsObj += item.specsOne + ',';
        });

        $('#HardwareComponentRegistrationModel_SerialNumbers').val(specsObj);

    }
    function add_row(item, record_count) {
        var row = '<tr id=row_' + record_count + '>' +
            '<td class="text-center text-muted">' + record_count + '</td>' +
            '<td class="text-left"> ' + $('#HardwareComponentRegistrationModel_HardwareComponentId option:selected').text() + '</td>' +
            '<td> ' + item.specsOne + '</td>' +
            '<td class="text-center">' +
            '<div class="buttons">' +
            '<a href="#" data-' + node_object_key + '=' + JSON.stringify(item) + ' class="pl-1 pr-1 row_edit">' +
            '<span class="fa fa-edit" aria-hidden="true"></span>' +
            '</a></div>' +
            '</td>' +
            '</tr>';
        return row;
    }

</script>
